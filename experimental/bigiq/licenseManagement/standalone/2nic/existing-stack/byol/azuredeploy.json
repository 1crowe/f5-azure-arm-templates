{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json", 
    "contentVersion": "5.3.0.0", 
    "parameters": {
        "adminUsername": {
            "defaultValue": "azureuser", 
            "metadata": {
                "description": "User name for the Virtual Machine."
            }, 
            "type": "string"
        }, 
        "authenticationType": {
            "allowedValues": [
                "password", 
                "sshPublicKey"
            ], 
            "defaultValue": "password", 
            "metadata": {
                "description": "Type of authentication to use on the Virtual Machine, password based authentication or key based authentication."
            }, 
            "type": "string"
        }, 
        "adminPasswordOrKey": {
            "metadata": {
                "description": "Password or SSH public key to login to the Virtual Machine. Note: There are a number of special characters that you should avoid using for F5 product user accounts.  See [K2873](https://support.f5.com/csp/article/K2873) for details. Note: If using key-based authentication, this should be the public key as a string, typically starting with **---- BEGIN SSH2 PUBLIC KEY ----** and ending with **---- END SSH2 PUBLIC KEY ----**."
            }, 
            "type": "securestring"
        }, 
        "dnsLabel": {
            "defaultValue": "", 
            "metadata": {
                "description": "Unique DNS Name for the Public IP address used to access the Virtual Machine."
            }, 
            "type": "string"
        }, 
        "instanceName": {
            "defaultValue": "f5vm01", 
            "metadata": {
                "description": "Name of the Virtual Machine."
            }, 
            "type": "string"
        }, 
        "instanceType": {
            "allowedValues": [
                "Standard_D4s_v3", 
                "Standard_D2s_v3", 
                "Standard_D8s_v3"
            ], 
            "defaultValue": "Standard_DS2_v2", 
            "metadata": {
                "description": "Instance size of the Virtual Machine."
            }, 
            "type": "string"
        }, 
        "bigIqVersion": {
            "allowedValues": [ 
                "6.0.0001674",
                "6.0.100813"
            ], 
            "defaultValue": "6.0.100813", 
            "metadata": {
                "description": "F5 BIG-IQ version you want to use."
            }, 
            "type": "string"
        }, 
        "bigIqLicenseKey1": {
            "defaultValue": "", 
            "metadata": {
                "description": "F5 BYOL BIG-IQ License Manager registration key."
            },
            "maxLength": 255,
            "minLength": 1, 
            "type": "string"
        },
        "licensePoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and registration key using the format of name:key. Leave Do_Not_Create if you do not want to create a licensing pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1, 
            "type": "string"
        },
        "regPoolKeys": {
            "defaultValue": "Do_Not_Create",
            "metadata": {
                "description": "Enter a pool name and a list of individual BIG-IP registration keys in the format of name:key,key,key. Leave Do_Not_Create if you do not want to create a reg key pool on BIG-IQ at this time."
            },
            "maxLength": 255,
            "minLength": 1, 
            "type": "string"
        },
        "numberOfInternalIps": {
            "allowedValues": [
                0,
                1
            ], 
            "defaultValue": 1, 
            "metadata": {
                "description": "The number of public/private IP addresses you want to deploy for the application traffic (internal) NIC on the BIG-IQ VE to be used for virtual servers."
            }, 
            "type": "int"
        }, 
        "vnetName": {
            "metadata": {
                "description": "The name of the existing virtual network to which you want to connect the BIG-IQ VEs."
            }, 
            "type": "string"
        }, 
        "vnetResourceGroupName": {
            "metadata": {
                "description": "The name of the resource group that contains the Virtual Network where the BIG-IQ VE will be placed."
            }, 
            "type": "string"
        }, 
        "mgmtSubnetName": {
            "metadata": {
                "description": "Name of the existing mgmt subnet - with external access to the Internet. **Important**: The subnet you provide for the mgmt NIC **must** be unique."
            }, 
            "type": "string"
        }, 
        "mgmtIpAddress": {
            "metadata": {
                "description": "MGMT subnet IP Address to use for the BIG-IQ management IP address."
            }, 
            "type": "string"
        }, 
        "internalSubnetName": {
            "metadata": {
                "description": "Name of the existing internal subnet. **Important**: The subnet you provide for the internal NIC **must** be unique."
            }, 
            "type": "string"
        }, 
        "internalIpAddressRangeStart": {
            "metadata": {
                "description": "The static private IP address want to assign to the first internal Azure public IP (for self IP). An additional private IP address will be assigned for each public IP address you specified in **numberOfInternalIps**.  For example, entering 10.100.1.50 here and choosing 2 in numberOfInternalIps would result in 10.100.1.50 (self IP), 10.100.1.51 and 10.100.1.52 being configured as static private IP addresses for internal virtual servers."
            }, 
            "type": "string"
        }, 
        "avSetChoice": {
            "defaultValue": "CREATE_NEW", 
            "metadata": {
                "description": "If you want the VM placed in a new Azure Availability Set, leave the default value of **CREATE_NEW**, otherwise specify the name of the existing Availability Set you want to use. Note: If you are using an existing AV Set, this deployment must be in the same Azure Resource Group as the AV Set."
            }, 
            "type": "string"
        }, 
        "ntpServer": {
            "defaultValue": "0.pool.ntp.org", 
            "metadata": {
                "description": "Leave the default NTP server the BIG-IQ uses, or replace the default NTP server with the one you want to use."
            }, 
            "type": "string"
        }, 
        "timeZone": {
            "defaultValue": "UTC", 
            "metadata": {
                "description": "If you would like to change the time zone the BIG-IQ uses, enter the time zone you want to use. This is based on the tz database found in /usr/share/zoneinfo (see the full list [here](https://github.com/F5Networks/f5-azure-arm-templates/blob/master/azure-timezone-list.md)). Example values: UTC, US/Pacific, US/Eastern, Europe/London or Asia/Singapore."
            }, 
            "type": "string"
        }, 
        "customImage": {
            "defaultValue": "OPTIONAL", 
            "metadata": {
                "description": "If you would like to deploy using a local BIG-IQ image, provide either the full URL to the VHD in Azure storage **or** the full resource ID to an existing Microsoft.Compute image resource.  **Note**: Unless specifically required, leave the default of **OPTIONAL**."
            }, 
            "type": "string"
        }, 
        "restrictedSrcAddress": {
            "defaultValue": "*", 
            "metadata": {
                "description": "Source Address(es) for Management Access. The IP address range used to SSH and access management GUI on the BIG-IQ."
            }, 
            "type": "string"
        },
        "restrictedSrcAddressApp": {
            "defaultValue": "*", 
            "metadata": {
                "description": "Source Address(es) for internal Management Access. The IP address range that can be used to access BIG-IQ on the specified internal network via port 443."
            }, 
            "type": "string"
        }, 
        "tagValues": {
            "defaultValue": {
                "application": "APP", 
                "cost": "COST", 
                "environment": "ENV", 
                "group": "GROUP", 
                "owner": "OWNER"
            }, 
            "metadata": {
                "description": "Default key/value resource tags will be added to the resources in this deployment, if you would like the values to be unique adjust them as needed for each key."
            }, 
            "type": "object"
        }, 
        "allowUsageAnalytics": {
            "allowedValues": [
                "Yes", 
                "No"
            ], 
            "defaultValue": "Yes", 
            "metadata": {
                "description": "This deployment can send anonymous statistics to F5 to help us determine how to improve our solutions. If you select **No** statistics are not sent."
            }, 
            "type": "string"
        }
    }, 
    "variables": {
        "computeApiVersion": "2017-12-01", 
        "networkApiVersion": "2017-11-01", 
        "storageApiVersion": "2017-10-01", 
        "location": "[resourceGroup().location]", 
        "adminPasswordOrKey": "[replace(parameters('adminPasswordOrKey'),'\\n', '\n')]", 
        "linuxConfiguration": {
            "disablePasswordAuthentication": true, 
            "ssh": {
                "publicKeys": [
                    {
                        "keyData": "[variables('adminPasswordOrKey')]", 
                        "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]"
                    }
                ]
            }
        }, 
        "subscriptionID": "[subscription().subscriptionId]", 
        "resourceGroupName": "[resourceGroup().name]", 
        "singleQuote": "'",
        "f5CloudLibsTag": "v4.4.0", 
        "f5CloudLibsAzureTag": "v2.4.0", 
        "dnsLabel": "[toLower(parameters('dnsLabel'))]", 
        "skuToUse": "f5-bigiq-virtual-edition-byol", 
        "offerToUse": "f5-big-iq", 
        "imagePlan": {
            "name": "[variables('skuToUse')]", 
            "product": "[variables('offerToUse')]", 
            "publisher": "f5-networks"
        }, 
        "imageReference": {
            "offer": "[variables('offerToUse')]", 
            "publisher": "f5-networks", 
            "sku": "[variables('skuToUse')]", 
            "version": "[parameters('bigIqVersion')]"
        }, 
        "instanceName": "[toLower(parameters('instanceName'))]", 
        "newAvailabilitySetName": "[concat(variables('dnsLabel'), '-avset')]", 
        "availabilitySetName": "[replace(parameters('avSetChoice'), 'CREATE_NEW', variables('newAvailabilitySetName'))]", 
        "virtualNetworkName": "[parameters('vnetName')]", 
        "vnetId": "[resourceId(parameters('vnetResourceGroupName'),'Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]", 
        "publicIPAddressType": "Static", 
        "mgmtPublicIPAddressName": "[concat(variables('dnsLabel'), '-mgmt-pip')]", 
        "mgmtPublicIPAddressId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('mgmtPublicIPAddressName'))]", 
        "mgmtNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-mgmt-nsg'))]", 
        "mgmtNicName": "[concat(variables('dnsLabel'), '-mgmt')]", 
        "mgmtSubnetName": "[parameters('mgmtSubnetName')]", 
        "mgmtSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('mgmtSubnetName'))]", 
        "mgmtSubnetPrivateAddress": "[parameters('mgmtIpAddress')]", 
        "intNsgID": "[resourceId('Microsoft.Network/networkSecurityGroups/',concat(variables('dnsLabel'),'-int-nsg'))]", 
        "intNicName": "[concat(variables('dnsLabel'), '-int')]", 
        "intSubnetName": "[parameters('internalSubnetName')]", 
        "intSubnetId": "[concat(variables('vnetId'), '/subnets/', variables('intSubnetName'))]", 
        "intSubnetPrivateAddress": "[parameters('internalIpAddressRangeStart')]", 
        "intSubnetPrivateAddressPrefixArray": "[split(parameters('internalIpAddressRangeStart'), '.')]", 
        "intSubnetPrivateAddressPrefix": "[concat(variables('intSubnetPrivateAddressPrefixArray')[0], '.', variables('intSubnetPrivateAddressPrefixArray')[1], '.', variables('intSubnetPrivateAddressPrefixArray')[2], '.')]", 
        "intSubnetPrivateAddressSuffixInt": "[int(variables('intSubnetPrivateAddressPrefixArray')[3])]", 
        "numberOfInternalIps": "[parameters('numberOfInternalIps')]", 
        "tagValues": "[parameters('tagValues')]", 
        "newDataStorageAccountName": "[concat(uniqueString(variables('dnsLabel'), resourceGroup().id, deployment().name), 'data000')]", 
        "dataStorageAccountType": "Standard_LRS", 
        "deploymentId": "[concat(variables('subscriptionId'), resourceGroup().id, deployment().name, variables('dnsLabel'))]", 
        "customImage": "[replace(parameters('customImage'), 'OPTIONAL', '')]", 
        "useCustomImage": "[not(empty(variables('customImage')))]", 
        "createNewCustomImage": "[contains(variables('customImage'), 'https://')]", 
        "newCustomImageName": "[concat(variables('dnsLabel'), 'image')]", 
        "storageProfileArray": {
            "customImage": {
                "imageReference": {
                    "id": "[if(variables('createNewCustomImage'), resourceId('Microsoft.Compute/images', variables('newCustomImageName')), variables('customImage'))]"
                }
            }, 
            "platformImage": {
                "imageReference": "[variables('imageReference')]", 
                "osDisk": {
                    "createOption": "FromImage"
                }
            }
        }, 
        "premiumInstanceArray": [
            "Standard_DS2", 
            "Standard_DS3", 
            "Standard_DS4", 
            "Standard_DS11", 
            "Standard_DS12", 
            "Standard_DS13", 
            "Standard_DS14", 
            "Standard_DS2_v2", 
            "Standard_DS3_v2", 
            "Standard_DS4_v2", 
            "Standard_DS5_v2", 
            "Standard_DS11_v2", 
            "Standard_DS12_v2", 
            "Standard_DS13_v2", 
            "Standard_DS14_v2", 
            "Standard_DS15_v2", 
            "Standard_F2S", 
            "Standard_F4S", 
            "Standard_F8S", 
            "Standard_F16S", 
            "Standard_GS2", 
            "Standard_GS3", 
            "Standard_GS4", 
            "Standard_GS5"
        ],
        "initScript": "IyEvYmluL2Jhc2gKCiMjIyBDb25maWd1cmUgZGVmYXVsdCB2YWx1ZXMKbG9nX2xldmVsPSJpbmZvIgpoZWxwPWZhbHNlCnNraXBfdmVyaWZ5PWZhbHNlCnNjcmlwdF9kaXI9JChkaXJuYW1lICQwKQoKVE1TSD0vdXNyL2Jpbi90bXNoCkNVUkw9L3Vzci9iaW4vY3VybApOT0RFPS91c3IvYmluL25vZGUKCiMjIyBGdW5jdGlvbnMgLSBUaGVzZSBzaG91bGQgZ28gaW50byBzZXBlcmF0ZSBmaWxlKHMpCiMgdXNhZ2U6IGxvZyBtZXNzYWdlCmZ1bmN0aW9uIGxvZygpIHsKICAgIGVjaG8gIiQoZGF0ZSAnKyVZLSVtLSVkVCVIOiVNOiVTWicpOiAkMSIKfQojIHVzYWdlOiBnZXRfdmVyc2lvbgpmdW5jdGlvbiBnZXRfdmVyc2lvbigpIHsKICAgIHJldD0kKCRUTVNIIHNob3cgc3lzIHZlcnNpb24gfCBncmVwIC1pIHByb2R1Y3QgfCBhd2sgJ3twcmludCAkMn0nKQogICAgZWNobyAke3JldCwsfQp9CiMgdXNhZ2U6IGpzb25pZnkga2V5OnZhbHVlLGtleTE6dmFsdWUxCmZ1bmN0aW9uIGpzb25pZnkoKSB7CiAgICBsaXN0PSQoZWNobyAkMSB8IHRyICcsJyAnICcpCiAgICBqc29uPSd7fScKICAgIGZvciBpIGluICRsaXN0IDsgZG8KICAgICAgICBrdj0oJChlY2hvICRpIHwgdHIgJzonICcgJykpCiAgICAgICAganNvbj0kKGVjaG8gJGpzb24gfCBqcSAtLWFyZyBrICR7a3ZbMF19IC0tYXJnIHYgJHtrdlsxXX0gJy4gfCAuWyRrXT0kdicpCiAgICBkb25lICAKICAgIGVjaG8gJGpzb24KfQojIHVzYWdlOiBnZXRfdmFsIGpzb25fb2JqZWN0IGtleQpmdW5jdGlvbiBnZXRfdmFsKCkgewogICAgcmV0PSQoZWNobyAkMSB8IGpxIC4kMiAtcikKICAgIGVjaG8gJHJldAp9CiMgdXNhZ2U6IG1ha2Ugc3VyZSB0aGVyZSBpcyBpbnRlcm5ldCBjb25uZWN0aW9uIHRvIEdpdEh1YgpmdW5jdGlvbiBjaGVja19pbnRlcm5ldF9jb25uZWN0aW9uIHsKICAgIGVjaG8gIi0tLSBDaGVja2luZyBHaXRodWIgc3RhdHVzIC0tLSIKICAgIGNoZWNrcz0wCiAgICBnaXRodWJfcmVzcG9uc2U9ImJhZCIKICAgIHdoaWxlIFsgJGNoZWNrcyAtbHQgMTIwIF0gOyBkbwogICAgICAgIGdpdGh1Yl9yZXNwb25zZT1gY3VybCBodHRwczovL3N0YXR1cy5naXRodWIuY29tL2FwaS9zdGF0dXMuanNvbj9jYWxsYmFjay1hcGlTdGF0dXMgfCBqcSAuc3RhdHVzIC0tcmF3LW91dHB1dGAKICAgICAgICBpZiBbICRnaXRodWJfcmVzcG9uc2UgPT0gImdvb2QiIF07IHRoZW4KICAgICAgICAgICAgbG9nICJHaXRIdWIgaXMgcmVhZHkiCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZmkKICAgICAgICBsb2cgIkdpdEh1YiBub3QgcmVhZHk6ICRjaGVja3MiCiAgICAgICAgbGV0IGNoZWNrcz1jaGVja3MrMQogICAgICAgIHNsZWVwIDUKICAgIGRvbmUKICAgIGlmIFsgJGdpdGh1Yl9yZXNwb25zZSA9PSAiYmFkIiBdOyB0aGVuCiAgICAgICAgbG9nICJObyBHaXRIdWIgaW50ZXJuZXQgY29ubmVjdGlvbi4iCiAgICAgICAgZXhpdAogICAgZmkKfQojIHVzYWdlOiBtY3BfcnVubmluZwpmdW5jdGlvbiBtY3BfcnVubmluZyB7CiAgICBjaGVja3M9MAogICAgd2hpbGUgWyAkY2hlY2tzIC1sdCAxMjAgXSA7IGRvCiAgICAgICAgJFRNU0ggLWEgc2hvdyBzeXMgbWNwLXN0YXRlIGZpZWxkLWZtdCB8IGdyZXAgLXEgcnVubmluZwogICAgICAgIGlmIFsgJD8gPT0gMCBdOyB0aGVuCiAgICAgICAgICAgIGxvZyAiTUNQRCByZWFkeSIKICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgICAgIGxvZyAiTUNQRCBub3QgcmVhZHk6ICRjaGVja3MiCiAgICAgICAgbGV0IGNoZWNrcz1jaGVja3MrMQogICAgICAgIHNsZWVwIDUKICAgIGRvbmUKfQojIHVzYWdlOiBEb3dubG9hZCBmcm9tIEdpdGh1YiB1bnRpbCBzdWNjZXNzZnVsCiMKIyAkMTogb3V0cHV0IGZpbGUgbmFtZQojICQyOiBVUkwKZnVuY3Rpb24gc2FmZV9kb3dubG9hZCB7CiAgICBjaGVja3M9MAogICAgd2hpbGUgWyAkY2hlY2tzIC1sdCAxMjAgXSA7IGRvCiAgICAgICAgJENVUkwgLS1mYWlsIC0tcmV0cnkgMjAgLS1yZXRyeS1kZWxheSA1IC0tcmV0cnktbWF4LXRpbWUgMjQwIC1vICQxICQyICYmIGJyZWFrCiAgICAgICAgbGV0IGNoZWNrcz1jaGVja3MrMQogICAgICAgIHNsZWVwIDUKICAgIGRvbmUKfQojIHVzYWdlOiBiYXNlX2NvbmZpZ19hdmFpbGFibGUgLSByZXNvbHZlcyBpc3N1ZSBmb3VuZCBpbiA2LjAuMCB2ZXJzaW9ucyBvZiBiaWctaXEKZnVuY3Rpb24gYmFzZV9jb25maWdfYXZhaWxhYmxlIHsKICAgIGNoZWNrcz0wCiAgICB3aGlsZSBbICRjaGVja3MgLWx0IDEyMCBdIDsgZG8KICAgICAgICAkVE1TSCAtYSBzaG93IHN5cyBtY3Atc3RhdGUgZmllbGQtZm10IHwgZ3JlcCAtcSBydW5uaW5nCiAgICAgICAgaWYgWyAtZiAvY29uZmlnL2JpZ2lwX2Jhc2UuY29uZiBdOyB0aGVuCiAgICAgICAgICAgIGxvZyAiQmFzZSBDb25maWcgZmlsZSBwcmVzZW50OyBzYXZpbmcgY29uZmlnIgogICAgICAgICAgICB0bXNoIHNhdmUgc3lzIGNvbmZpZwogICAgICAgICAgICBjYXQgL2NvbmZpZy9iaWdpcF9iYXNlLmNvbmYKICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgICAgIGxvZyAiQmFzZSBjb25maWcgZmlsZSBub3QgeWV0IHByZXNlbnQ6ICRjaGVja3MiCiAgICAgICAgbGV0IGNoZWNrcz1jaGVja3MrMQogICAgICAgIHNsZWVwIDUKICAgIGRvbmUKfQojIHVzYWdlOiBnZXRfbmV0X2luZm8gZXRoMCBuc3xndyBpbmNsdWRlX2NpZHIKZnVuY3Rpb24gZ2V0X25ldF9pbmZvKCkgewogICAgUkVUPSIiCiAgICBDSURSX0JMT0NLPSIiCiAgICBpZiBbWyAkY2xvdWQgPT0gImF6dXJlIiBdXTsgdGhlbgogICAgICAgIGFkZF9pbnQ9MQogICAgICAgIElGX01BQz0kKGlmY29uZmlnICQxIHwgZ3JlcCAtaSBod2FkZHIgfCBhd2sgJ3twcmludCAkNX0nIHwgc2VkICdzLzovL2cnKQogICAgICAgIElGX0lORk89JChjdXJsIC1zZiAtLXJldHJ5IDIwIGN1cmwgLUggTWV0YWRhdGE6dHJ1ZSAiaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9tZXRhZGF0YS9pbnN0YW5jZS9uZXR3b3JrL2ludGVyZmFjZT9hcGktdmVyc2lvbj0yMDE3LTA4LTAxIiB8IGpxICcuW10gfCBzZWxlY3QoLm1hY0FkZHJlc3M9PSInJHtJRl9NQUN9JyIpJykKICAgICAgICBDSURSX0JMT0NLPSQoZWNobyAke0lGX0lORk99IHwganEgLmlwdjQuc3VibmV0WzBdLmFkZHJlc3MgLS1yYXctb3V0cHV0KQogICAgICAgIENJRFJfQkxPQ0srPSIvIgogICAgICAgIENJRFJfQkxPQ0srPSQoZWNobyAke0lGX0lORk99IHwganEgLmlwdjQuc3VibmV0WzBdLnByZWZpeCAtLXJhdy1vdXRwdXQpCiAgICBlbGlmIFtbICRjbG91ZCA9PSAiYXdzIiBdXTsgdGhlbgogICAgICAgIGNpZHJfYmxvY2tfdXJpPSJ2cGMtaXB2NC1jaWRyLWJsb2NrIgogICAgICAgIGFkZF9pbnQ9MgogICAgICAgICMgSWYgZ2V0dGluZyBnYXRld2F5LCB1cGRhdGUgbmVjZXNzYXJ5IHZhcnMKICAgICAgICBpZiBbWyAkMiA9PSAiZ3ciIF1dIDsgdGhlbiBjaWRyX2Jsb2NrX3VyaT0ic3VibmV0LWlwdjQtY2lkci1ibG9jayIgOyBhZGRfaW50PTEgOyBmaQogICAgICAgIElGX01BQz0kKGlmY29uZmlnICQxIHwgZ3JlcCAtaSBod2FkZHIgfCBhd2sgJ3twcmludCB0b2xvd2VyKCQ1KX0nKQogICAgICAgIENJRFJfQkxPQ0s9JChjdXJsIC1zZiAtLXJldHJ5IDIwIGh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L21ldGEtZGF0YS9uZXR3b3JrL2ludGVyZmFjZXMvbWFjcy8ke0lGX01BQ30vJHtjaWRyX2Jsb2NrX3VyaX0pCiAgICBmaQogICAgUkVUPSQoZWNobyAke0NJRFJfQkxPQ0slLyp9IHwgYXdrIC1GLiAneyBwcmludGYgIiVkLiVkLiVkLiVkIiwgJDEsICQyLCAkMywgJDQrJyR7YWRkX2ludH0nIH0nKQogICAgIyBJbmNsdWRlIG1hc2sgaW4gcmVzcG9uc2UgaWYgcmVxdWVzdGVkCiAgICBpZiBbWyAtbiAiJDMiIF1dIDsgdGhlbiBlY2hvICR7UkVUfS8ke0NJRFJfQkxPQ0sjKi99IDsgZWxzZSBlY2hvICRSRVQgOyBmaQp9CgpyZWFkIC1yIC1kICcnIFVTQUdFIDw8IEVPTQogICAgVXNhZ2U6ICQwCiAgICAgICAgLS1oZWxwICAgICAgICAgICAgICAgICAgICAgIFByaW50IHVzYWdlIG1lc3NhZ2UgYW5kIGV4aXQKICAgICAgICAtLWxvZy1sZXZlbCA8c3RyaW5nPiAgICAgICAgTGV2ZWwgb2YgbG9nZ2luZyBkZXNpcmVkOiBlcnJvciwgd2FybiwgaW5mbywgZGVidWcKICAgICAgICAtLWNsb3VkIDxzdHJpbmc+ICAgICAgICAgICAgQ2xvdWQgZW52aXJvbm1lbnQgZXhlY3V0ZWQgYWdhaW5zdDogYXdzCiAgICAgICAgLS1za2lwLXZlcmlmeSA8c3RyaW5nPiAgICAgIFNraXAgdmVyaWZpY2F0aW9uIG9mIGRlcGVuZGVuY2llcwogICAgICAgIC0tbGljZW5zZSA8c3RyaW5nPiAgICAgICAgICBMaWNlbnNlIGZvciB0aGUgZGV2aWNlCiAgICAgICAgLS1udHAgPHN0cmluZz4gICAgICAgICAgICAgIE5UUCBmb3IgdGhlIGRldmljZQogICAgICAgIC0tdGltZXpvbmUgPHN0cmluZz4gICAgICAgICBUaW1lem9uZSBmb3IgdGhlIGRldmljZQogICAgICAgIC0tZGF0YS1pbnRlcmZhY2UgPHN0cmluZz4gICBQcmltYXJ5IGludGVyZmFjZSB0byB1c2UgZm9yIGRhdGEtcGxhbmUKICAgICAgICAtLXZsYW4gPHN0cmluZz4gICAgICAgICAgICAgVkxBTihzKSB0byBjcmVhdGUgb24gdGhlIGRldmljZSAoOyBmb3IgbXVsdGlwbGUpICduOmV4dCxuaWM6MS4xJwogICAgICAgIC0tc2VsZi1pcCA8c3RyaW5nPiAgICAgICAgICBTZWxmIElQKHMpIHRvIGNyZWF0ZSBvbiB0aGUgZGV2aWNlICg7IGZvciBtdWx0aXBsZSk6ICduOmV4dCxhOngueC54LngsdjpleHQsaTpldGgxJwogICAgICAgIC0tdXNhZ2UtYW5hbHl0aWNzIDxzdHJpbmc+ICBVc2FnZSBhbmFseXRpY3MgdG8gc2VuZDogJ2NOOnZhbCxyOnZhbCxjSTp2YWwsZEk6dmFsLGxUOnZhbCxiSVY6dmFsLHROOnZhbCx0Vjp2YWwsc2VuZDp5ZXMnCiAgICAgICAgLS1jcmVhdGUtbGljZW5zZS1wb29sICAgICAgIENyZWF0ZXMgbGljZW5zZSBwb29sLCBzZW5kOiBuYW1lOnJlZ19rZXkKICAgICAgICAtLWNyZWF0ZS1yZWcta2V5LXBvb2wgICAgICAgQ3JlYXRlcyBhIHJlZ2tleSBwb29sLCBzZW5kOiBuYW1lOnJlZ19rZXlfbGlzdAogICAgICAgIC0tZmNsLXRhZyAgICAgICAgICAgICAgICAgICBGNSBjbG91ZCBsaWIgdGFnIHRvIGRvd25sb2FkIGY1LWNsb3VkLWxpYnMudGFyLmd6CiAgICAgICAgLS1mY2wtY2xvdWQtdGFnICAgICAgICAgICAgIEY1IHNwZWNpZmllZCBjbG91ZCB0YWcgdG8gZG93bmxvYWQgZjUtY2xvdWQtbGlicy08Y2xvdWQ+LnRhci5negoKRU9NCgojIyMgUGFyc2UgY29tbWFuZCBsaW5lIGFyZ3VtZW50cwp3aGlsZSBbWyAkIyAtZ3QgMCBdXSA7IGRvCiAgICBjYXNlICIkMSIgaW4KICAgICAgICAtLWhlbHApCiAgICAgICAgICAgIGhlbHA9dHJ1ZTsKICAgICAgICAgICAgc2hpZnQgOzsKICAgICAgICAtLWxvZy1sZXZlbCkKICAgICAgICAgICAgbG9nX2xldmVsPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tY2xvdWQpCiAgICAgICAgICAgIGNsb3VkPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tc2tpcC12ZXJpZnkpCiAgICAgICAgICAgIHNraXBfdmVyaWZ5PXRydWUKICAgICAgICAgICAgc2hpZnQgOzsKICAgICAgICAtLWxpY2Vuc2UpCiAgICAgICAgICAgIGxpY2Vuc2U9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1udHApCiAgICAgICAgICAgIG50cD0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLXRpbWV6b25lKQogICAgICAgICAgICB0aW1lem9uZT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWRhdGEtaW50ZXJmYWNlKQogICAgICAgICAgICBkYXRhX2ludGVyZmFjZT0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLXVzYWdlLWFuYWx5dGljcykKICAgICAgICAgICAgdXNhZ2VfYW5hbHl0aWNzPSIkMiIKICAgICAgICAgICAgc2hpZnQgOzsKICAgICAgICAtLXZsYW4pCiAgICAgICAgICAgIHZsYW49IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgLS1zZWxmLWlwKQogICAgICAgICAgICBzZWxmX2lwPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tY3JlYXRlLWxpY2Vuc2UtcG9vbCkKICAgICAgICAgICAgbGljZW5zZV9wb29sPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tY3JlYXRlLXJlZy1rZXktcG9vbCkKICAgICAgICAgICAgcmVnX2tleV9wb29sPSIkMiIKICAgICAgICAgICAgc2hpZnQgMiA7OwogICAgICAgIC0tZmNsLXRhZykKICAgICAgICAgICAgZmNsX3RhZz0iJDIiCiAgICAgICAgICAgIHNoaWZ0IDIgOzsKICAgICAgICAtLWZjbC1jbG91ZC10YWcpCiAgICAgICAgICAgIGZjbF9jbG91ZF90YWc9IiQyIgogICAgICAgICAgICBzaGlmdCAyIDs7CiAgICAgICAgKnwtLSkKICAgICAgICAgICAgc2hpZnQKICAgICAgICAgICAgYnJlYWsgOzsKICAgIGVzYWMKZG9uZQoKaWYgJGhlbHAgOyB0aGVuCiAgICBlY2hvICIkVVNBR0UiCiAgICBleGl0CmZpCgojIFZlcmlmeSByZXF1aXJlZCBwYXJhbWV0ZXJzCnJlcXVpcmVkPSgiY2xvdWQiKQpmb3IgaSBpbiAke3JlcXVpcmVkW0BdfSA7IGRvCiAgICBpZiBbIC16ICR7IWl9IF0gOyB0aGVuCiAgICAgICAgbG9nICJBIHJlcXVpcmVkIHBhcmFtZXRlciBpcyBtaXNzaW5nOiAkaSIKICAgICAgICBleGl0CiAgICBmaQpkb25lCgojIENoZWNrIGZvciAiRG8gTm90IENyZWF0ZSIgaW4gY3JlYXRlIHBvb2wgcGFybWV0ZXJzCnNob3B0IC1zIG5vY2FzZW1hdGNoCmlmIFtbICRsaWNlbnNlX3Bvb2wgPT0gIkRvX05vdF9DcmVhdGUiIF1dIDsgdGhlbgogICAgbG9nICJTZXR0aW5nIGxpY2Vuc2luZyBwb29sIHRvIG51bGwgYXMgJ0RvX05vdF9DcmVhdGUnIGhhcyBiZWVuIHNwZWNpZmllZDogJGxpY2Vuc2luZ19wb29sIgogICAgbGljZW5zZV9wb29sPSIiCmZpCmlmIFtbICRyZWdfa2V5X3Bvb2wgPT0gIkRvX05vdF9DcmVhdGUiIF1dIDsgdGhlbgogICAgbG9nICJTZXR0aW5nIHJlZyBrZXkgcG9vbCB0byBudWxsIGFzICdEb19Ob3RfQ3JlYXRlJyBoYXMgYmVlbiBzcGVjaWZpZWQ6ICRsaWNlbnNpbmdfcG9vbCIKICAgIHJlZ19rZXlfcG9vbD0iIgpmaQpzaG9wdCAtdSBub2Nhc2VtYXRjaAoKIyMjIEluc3RhbGwgZGVwZW5kZW5jaWVzICMjIwojIyBUaGVyZSBtdXN0IGJlIEdpdEh1YiBpbnRlcm5ldCBjb25uZWN0aW9uCmNoZWNrX2ludGVybmV0X2Nvbm5lY3Rpb24KCmJhc2VfdXJsPSJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRjVOZXR3b3JrcyIKYmFzZV9kaXI9Ii9jb25maWcvY2xvdWQiCmJhc2VfbG9nX2Rpcj0iL3Zhci9sb2cvY2xvdWQvJHtjbG91ZH0iCmJhc2VfZGVwZW5kZW5jeV9kaXI9IiR7YmFzZV9kaXJ9LyR7Y2xvdWR9L25vZGVfbW9kdWxlcy9AZjVkZXZjZW50cmFsIgoKIyMgRG93bmxvYWQKZGVwZW5kZW5jaWVzPSgiJHtiYXNlX3VybH0vZjUtY2xvdWQtbGlicy8ke2ZjbF90YWd9L2Rpc3QvZjUtY2xvdWQtbGlicy50YXIuZ3oiKQpkZXBlbmRlbmNpZXMrPSgiJHtiYXNlX3VybH0vZjUtY2xvdWQtbGlicy0ke2Nsb3VkfS8ke2ZjbF9jbG91ZF90YWd9L2Rpc3QvZjUtY2xvdWQtbGlicy0ke2Nsb3VkfS50YXIuZ3oiKQpkZXBlbmRlbmNpZXMrPSgiJHtiYXNlX3VybH0vZjUtY2xvdWQtbGlicy8ke2ZjbF90YWd9L2Rpc3QvdmVyaWZ5SGFzaCIpCgpmb3IgaSBpbiAke2RlcGVuZGVuY2llc1tAXX0gOyBkbwogICAgbG9nICJEb3dubG9hZGluZyBkZXBlbmRlbmN5OiAkaSIKICAgIGY9JChiYXNlbmFtZSAkaSkKICAgIHNhZmVfZG93bmxvYWQgJHtiYXNlX2Rpcn0vJGYgJGkKICAgICMgJENVUkwgLWtzZiAtLXJldHJ5IDEwIC0tcmV0cnktZGVsYXkgNSAtLXJldHJ5LW1heC10aW1lIDI0MCAtbyAke2Jhc2VfZGlyfS8kZiAkaQpkb25lCgojIyBWZXJpZnkKIyBNQ1AgbXVzdCBiZSBydW5uaW5nIGZpcnN0Cm1jcF9ydW5uaW5nCmJhc2VfY29uZmlnX2F2YWlsYWJsZQoKaWYgISAkc2tpcF92ZXJpZnkgOyB0aGVuCiAgICB2ZXJpZnlfc2NyaXB0PSIke2Jhc2VfZGlyfS92ZXJpZnlIYXNoIgogICAgaWYgISAkVE1TSCBsb2FkIHN5cyBjb25maWcgbWVyZ2UgZmlsZSAkdmVyaWZ5X3NjcmlwdCA7IHRoZW4KICAgICAgICBsb2cgIkNMSSB2ZXJpZmljYXRpb24gc2NyaXB0IGlzIG5vdCB2YWxpZDogJHZlcmlmeV9zY3JpcHQiCiAgICAgICAgZXhpdCAxCiAgICBmaQoKICAgIGZvciBpIGluICR7ZGVwZW5kZW5jaWVzW0BdfSA7IGRvCiAgICAgICAgZj0kKGJhc2VuYW1lICRpKQogICAgICAgIGlmIFtbICRmICE9ICJ2ZXJpZnlIYXNoIiBdXSA7IHRoZW4KICAgICAgICAgICAgbG9nICJWZXJpZnlpbmcgZGVwZW5kZW5jeTogJGYiCiAgICAgICAgICAgIGlmICEgJFRNU0ggcnVuIGNsaSBzY3JpcHQgdmVyaWZ5SGFzaCAiL2NvbmZpZy9jbG91ZC8kZiIgOyB0aGVuCiAgICAgICAgICAgICAgICBsb2cgIkRlcGVuZGVuY3kgaXMgbm90IHZhbGlkOiAkZiIKICAgICAgICAgICAgICAgIGV4aXQgMQogICAgICAgICAgICBmaQogICAgICAgIGZpCiAgICBkb25lCmVsc2UKICAgIGxvZyAiV2FybmluZzogU2tpcHBpbmcgZGVwZW5kZW5jeSB2ZXJpZmljYXRpb24iCmZpCgojIyBJbnN0YWxsCm1rZGlyIC1wICRiYXNlX2RlcGVuZGVuY3lfZGlyCmZvciBpIGluICR7ZGVwZW5kZW5jaWVzW0BdfSA7IGRvCiAgICBmPSQoYmFzZW5hbWUgJGkpCiAgICBsb2cgIkluc3RhbGxpbmcgZGVwZW5kZW5jeTogJGYiCiAgICBpZiBbWyAkZiA9PSAqIi50YXIiKiBdXSA7IHRoZW4KICAgICAgICB0YXIgeGZ6ICR7YmFzZV9kaXJ9LyR7Zn0gLUMgJGJhc2VfZGVwZW5kZW5jeV9kaXIKICAgIGZpCmRvbmUKCiMjIFNpZ25hbAp0b3VjaCAiJHtiYXNlX2Rpcn0vY2xvdWRMaWJzUmVhZHkiCgojIyMgUHJvdmlzaW9uIERldmljZSAjIyMKbWtkaXIgLXAgJGJhc2VfbG9nX2Rpcgpob3N0bmFtZT0iIgppZiBbWyAkY2xvdWQgPT0gImF3cyIgXV07IHRoZW4KICAgIGhvc3RuYW1lPSQoJENVUkwgLXNmIC0tcmV0cnkgMjAgaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvbWV0YS1kYXRhL2hvc3RuYW1lKQplbGlmIFtbICRjbG91ZCA9PSAiYXp1cmUiIF1dOyB0aGVuCiAgICBtZXRhZGF0YT0kKCRDVVJMIC1IIE1ldGFkYXRhOnRydWUgImh0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbWV0YWRhdGEvaW5zdGFuY2UvY29tcHV0ZT9hcGktdmVyc2lvbj0yMDE3LTEyLTAxIikKICAgIGhvc3RuYW1lPSQoZWNobyAke21ldGFkYXRhfSB8IGpxIC5uYW1lIC0tcmF3LW91dHB1dCkKICAgIGhvc3RuYW1lKz0iLiIKICAgIGhvc3RuYW1lKz0kKGVjaG8gJHttZXRhZGF0YX0gfCBqcSAubG9jYXRpb24gLS1yYXctb3V0cHV0KQogICAgaG9zdG5hbWUrPSIuY2xvdWRhcHAuYXp1cmUuY29tIgpmaQpob3N0PSJsb2NhbGhvc3QiCnNlcGFyYXRvcj0iOyIKCiMgQ291bGQgdXNlIGEgZ2VuZXJpYyAtLW9uYm9hcmR8LS1uZXR3b3JrfGV0YyBmb3Igb3B0aW9uYWwgYXJndW1lbnRzCiMgaW5zdGVhZCwgYXQgbGVhc3QgZm9yIG5vdyBpbXBsZW1lbnQgdGhlIGFkZGl0aW9uYWwgYWJzdHJhY3Rpb24KCiMjIE9uYm9hcmQKb25ib2FyZF9hcmdzPSIiCmlmIFsgLW4gIiRsaWNlbnNlIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWxpY2Vuc2UgJHtsaWNlbnNlfSAiIDsgZmkKaWYgWyAtbiAiJG50cCIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1udHAgJHtudHB9ICIgOyBmaQppZiBbIC1uICIkdGltZXpvbmUiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tdHogJHt0aW1lem9uZX0gIiA7IGZpCmlmIFsgLW4gIiRsaWNlbnNlX3Bvb2wiIF0gOyB0aGVuIAogICAgIyBDaGVjayBmb3IgbXVsaXRpcGxlIGxpY2Vuc2UgcG9vbHMKICAgIE9JRlM9JElGUwogICAgSUZTPSIsIjsKICAgIGxpY2Vuc2VBcnJheT0oJGxpY2Vuc2VfcG9vbCk7CiAgICBmb3IgaSBpbiAke2xpY2Vuc2VBcnJheVtAXX07IGRvCiAgICAgICAgZmxhZz0nIC0tY3JlYXRlLWxpY2Vuc2UtcG9vbCAnCiAgICAgICAgY2F0X2FyZ3M9IiR7Y2F0X2FyZ3N9JHtmbGFnfSRpIgogICAgZG9uZQogICAgSUZTPSRPSUZTOwogICAgb25ib2FyZF9hcmdzKz0iJHtjYXRfYXJnc30gIiA7IGZpCgppZiBbIC1uICIkcmVnX2tleV9wb29sIiBdIDsgdGhlbiBvbmJvYXJkX2FyZ3MrPSItLWNyZWF0ZS1yZWcta2V5LXBvb2wgJHtyZWdfa2V5X3Bvb2x9ICIgOyBmaQoKaWYgW1sgJGNsb3VkID09ICJhd3MiIF1dOyB0aGVuCiAgICBpZiBbIC1uICIkZGF0YV9pbnRlcmZhY2UiIF0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tZG5zICQoZ2V0X25ldF9pbmZvICRkYXRhX2ludGVyZmFjZSBucykgIiA7IGZpCmVsaWYgW1sgJGNsb3VkID09ICJhenVyZSIgXV07IHRoZW4KICAgIGlmIFsgLW4gIiRkYXRhX2ludGVyZmFjZSIgXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1kbnMgMTY4LjYzLjEyOS4xNiAiIDsgZmkKZmkKCmlmIFtbICIkKGdldF92ZXJzaW9uKSIgPT0gImJpZy1pcSIgXV0gOyB0aGVuIG9uYm9hcmRfYXJncys9Ii0tc2V0LW1hc3Rlci1rZXkgIiA7IGZpCmlmIFsgLW4gIiR1c2FnZV9hbmFseXRpY3MiIF0gOyB0aGVuCiAgICBvPSQoanNvbmlmeSAkdXNhZ2VfYW5hbHl0aWNzKQogICAgIyBPYmZ1c2NhdGUgc2Vuc2l0aXZlIGluZm9ybWF0aW9uCiAgICBjST0kKGVjaG8gJChnZXRfdmFsICIkbyIgY0kpIHwgc2hhNTEyc3VtIHwgY3V0IC1kICIgIiAtZiAxKQogICAgZEk9JChlY2hvICQoZ2V0X3ZhbCAiJG8iIGRJKSB8IHNoYTUxMnN1bSB8IGN1dCAtZCAiICIgLWYgMSkKICAgIG1ldHJpY3MrPSJjbG91ZE5hbWU6JChnZXRfdmFsICIkbyIgY04pLHJlZ2lvbjokKGdldF92YWwgIiRvIiByKSxjdXN0b21lcklkOiR7Y0l9IgogICAgbWV0cmljcys9IixkZXBsb3ltZW50SWQ6JHtkSX0sbGljZW5zZVR5cGU6JChnZXRfdmFsICIkbyIgbFQpLGJpZ0lwVmVyc2lvbjokKGdldF92YWwgIiRvIiBiSVYpIgogICAgbWV0cmljcys9Iix0ZW1wbGF0ZU5hbWU6JChnZXRfdmFsICIkbyIgdE4pLHRlbXBsYXRlVmVyc2lvbjokKGdldF92YWwgIiRvIiB0VikgIgogICAgc2VuZF9hbmFseXRpY3M9JChnZXRfdmFsICIkbyIgc2VuZCkKICAgIGlmIFtbICIke3NlbmRfYW5hbHl0aWNzLCx9IiA9PSAieWVzIiBdXSA7IHRoZW4gb25ib2FyZF9hcmdzKz0iLS1tZXRyaWNzICRtZXRyaWNzICIgOyBmaQpmaQoKJE5PREUgIiR7YmFzZV9kZXBlbmRlbmN5X2Rpcn0vZjUtY2xvdWQtbGlicy9zY3JpcHRzL29uYm9hcmQuanMiIC0taG9zdCAkaG9zdCAtLWxvZy1sZXZlbCAkbG9nX2xldmVsIFwKICAgIC0tb3V0cHV0ICIke2Jhc2VfbG9nX2Rpcn0vb25ib2FyZC5sb2ciIC0tc2lnbmFsIE9OQk9BUkRfRE9ORSAtLWhvc3RuYW1lICRob3N0bmFtZSAkb25ib2FyZF9hcmdzICY+PiAke2Jhc2VfbG9nX2Rpcn0vaW5zdGFsbC5sb2cKCiMgVE9ETzogUmFjZSBjb25kaXRpb24gYmV0d2VlbiBvbmJvYXJkL25ldHdvcmsgLSBVc2luZyBhdXRoIHRva2VuIHJlc3VsdHMgaW4gNDAzICJub3QgYXV0aG9yaXplZCIKIyBpZiBuZXR3b3JrIGNhbGwgaW1tZWRpYXRlbHkgZm9sbG93cyBvbmJvYXJkLiAgVXNlIGZvbGxvd2luZyBwbGFjZWhvbGRlciB1bnRpbCBmaXhlZCBpbiBmNS1jbG91ZC1saWJzCiMgYWRkaW5nIC0td2FpdC1mb3Igc2lnbmFsIGZvciBuZXR3b3JrIGNhbGwuCndhaXRfdGltZT0zMApsb2cgIldhaXRpbmc6ICR3YWl0X3RpbWUiCnNsZWVwICR3YWl0X3RpbWUKCiMjIE5ldHdvcmsKbmV0d29ya19hcmdzPSIiCmlmIFsgLW4gIiRkYXRhX2ludGVyZmFjZSIgXSA7IHRoZW4gbmV0d29ya19hcmdzKz0iLS1kZWZhdWx0LWd3ICQoZ2V0X25ldF9pbmZvICRkYXRhX2ludGVyZmFjZSBndykgIiA7IGZpCmlmIFsgLW4gIiR2bGFuIiBdIDsgdGhlbgogICAgZm9yIGkgaW4gJChlY2hvICR2bGFuIHwgdHIgIiRzZXBhcmF0b3IiICcgJykgOyBkbwogICAgICAgIG89JChqc29uaWZ5ICRpKQogICAgICAgIG5ldHdvcmtfYXJncys9Ii0tdmxhbiBuYW1lOiQoZ2V0X3ZhbCAiJG8iIG4pLG5pYzokKGdldF92YWwgIiRvIiBuaWMpICIKICAgIGRvbmUKZmkKaWYgWyAtbiAiJHNlbGZfaXAiIF0gOyB0aGVuCiAgICBmb3IgaSBpbiAkKGVjaG8gJHNlbGZfaXAgfCB0ciAiJHNlcGFyYXRvciIgJyAnKSA7IGRvCiAgICAgICAgbz0kKGpzb25pZnkgJGkpCiAgICAgICAgZ3c9JChnZXRfbmV0X2luZm8gJChnZXRfdmFsICIkbyIgaSkgZ3cgY2lkcikKICAgICAgICBuZXR3b3JrX2FyZ3MrPSItLXNlbGYtaXAgbmFtZTokKGdldF92YWwgIiRvIiBuKSxhZGRyZXNzOiQoZ2V0X3ZhbCAiJG8iIGEpLyR7Z3cjKi99LHZsYW46JChnZXRfdmFsICIkbyIgdikgIgogICAgZG9uZQpmaQoKJE5PREUgIiR7YmFzZV9kZXBlbmRlbmN5X2Rpcn0vZjUtY2xvdWQtbGlicy9zY3JpcHRzL25ldHdvcmsuanMiIC0taG9zdCAkaG9zdCAtLWxvZy1sZXZlbCAkbG9nX2xldmVsIFwKICAgIC0tb3V0cHV0ICIke2Jhc2VfbG9nX2Rpcn0vbmV0d29yay5sb2ciIC0tc2lnbmFsIE5FVFdPUktfRE9ORSAkbmV0d29ya19hcmdzICY+PiAke2Jhc2VfbG9nX2Rpcn0vaW5zdGFsbC5sb2cK",
        "customConfig": "### START (INPUT) CUSTOM CONFIGURATION HERE\n", 
        "installCustomConfig": "[concat(variables('singleQuote'), '#!/bin/bash\n', variables('customConfig'), variables('singleQuote'))]"
    }, 
    "resources": [
        {
            "apiVersion": "[variables('networkApiVersion')]", 
            "location": "[variables('location')]", 
            "name": "[variables('mgmtPublicIPAddressName')]", 
            "properties": {
                "dnsSettings": {
                    "domainNameLabel": "[variables('dnsLabel')]"
                }, 
                "idleTimeoutInMinutes": 30, 
                "publicIPAllocationMethod": "[variables('publicIPAddressType')]"
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Network/publicIPAddresses"
        }, 
        {
            "apiVersion": "[variables('networkApiVersion')]", 
            "dependsOn": [
                "[variables('mgmtPublicIPAddressId')]", 
                "[variables('mgmtNsgID')]"
            ], 
            "location": "[variables('location')]", 
            "name": "[variables('mgmtNicName')]", 
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "[concat(variables('instanceName'), '-ipconfig1')]", 
                        "properties": {
                            "PublicIpAddress": {
                                "Id": "[variables('mgmtPublicIPAddressId')]"
                            }, 
                            "privateIPAddress": "[variables('mgmtSubnetPrivateAddress')]", 
                            "privateIPAllocationMethod": "Static", 
                            "subnet": {
                                "id": "[variables('mgmtSubnetId')]"
                            }
                        }
                    }
                ], 
                "networkSecurityGroup": {
                    "id": "[variables('mgmtNsgID')]"
                }
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Network/networkInterfaces"
        }, 
        {
            "apiVersion": "[variables('networkApiVersion')]", 
            "dependsOn": [
                "[variables('intNsgID')]"
            ], 
            "location": "[variables('location')]", 
            "name": "[variables('intNicName')]", 
            "properties": {
                "copy": [
                    {
                        "count": "[add(variables('numberOfInternalIps'), 1)]", 
                        "input": {
                            "name": "[if(equals(copyIndex('ipConfigurations', 1), 1), concat(variables('instanceName'), '-self-ipconfig'), concat(variables('resourceGroupName'), '-int-ipconfig', sub(copyIndex('ipConfigurations', 1), 2)))]", 
                            "properties": {
                                "primary": "[if(equals(copyIndex('ipConfigurations', 1), 1), 'True', 'False')]", 
                                "privateIPAddress": "[if(equals(copyIndex('ipConfigurations', 1), 1), variables('intSubnetPrivateAddress'), concat(variables('intSubnetPrivateAddressPrefix'), add(variables('intSubnetPrivateAddressSuffixInt'), sub(copyIndex('ipConfigurations', 1), 1))))]", 
                                "privateIPAllocationMethod": "Static", 
                                "subnet": {
                                    "id": "[variables('intSubnetId')]"
                                }
                            }
                        }, 
                        "name": "ipConfigurations"
                    }
                ], 
                "networkSecurityGroup": {
                    "id": "[concat(variables('intNsgID'))]"
                }
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Network/networkInterfaces"
        }, 
        {
            "apiVersion": "[variables('networkApiVersion')]", 
            "location": "[variables('location')]", 
            "name": "[concat(variables('dnsLabel'), '-mgmt-nsg')]", 
            "properties": {
                "securityRules": [
                    {
                        "name": "mgmt_allow_https", 
                        "properties": {
                            "access": "Allow", 
                            "description": "", 
                            "destinationAddressPrefix": "*", 
                            "destinationPortRange": "443", 
                            "direction": "Inbound", 
                            "priority": 101, 
                            "protocol": "Tcp", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]", 
                            "sourcePortRange": "*"
                        }
                    }, 
                    {
                        "name": "allow_ssh_22", 
                        "properties": {
                            "access": "Allow", 
                            "description": "", 
                            "destinationAddressPrefix": "*", 
                            "destinationPortRange": "22", 
                            "direction": "Inbound", 
                            "priority": 102, 
                            "protocol": "Tcp", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddress')]", 
                            "sourcePortRange": "*"
                        }
                    }
                ]
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Network/networkSecurityGroups"
        }, 
        {
            "apiVersion": "[variables('networkApiVersion')]", 
            "location": "[variables('location')]", 
            "name": "[concat(variables('dnsLabel'), '-int-nsg')]", 
            "properties": {
                "securityRules": [
                    {
                        "name": "int_allow_https", 
                        "properties": {
                            "access": "Allow", 
                            "description": "", 
                            "destinationAddressPrefix": "*", 
                            "destinationPortRange": "443", 
                            "direction": "Inbound", 
                            "priority": 101, 
                            "protocol": "Tcp", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]", 
                            "sourcePortRange": "*"
                        }
                    }, 
                    {
                        "name": "int_allow_ssh_22", 
                        "properties": {
                            "access": "Allow", 
                            "description": "", 
                            "destinationAddressPrefix": "*", 
                            "destinationPortRange": "22", 
                            "direction": "Inbound", 
                            "priority": 102, 
                            "protocol": "Tcp", 
                            "sourceAddressPrefix": "[parameters('restrictedSrcAddressApp')]", 
                            "sourcePortRange": "*"
                        }
                    }
                ]
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Network/networkSecurityGroups"
        }, 
        {
            "apiVersion": "[variables('computeApiVersion')]", 
            "condition": "[equals(toUpper(parameters('avSetChoice')), 'CREATE_NEW')]", 
            "location": "[variables('location')]", 
            "name": "[variables('availabilitySetName')]", 
            "properties": {
                "PlatformFaultDomainCount": 2, 
                "PlatformUpdateDomainCount": 2
            }, 
            "sku": {
                "name": "Aligned"
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Compute/availabilitySets"
        }, 
        {
            "apiVersion": "[variables('storageApiVersion')]", 
            "kind": "Storage", 
            "location": "[variables('location')]", 
            "name": "[variables('newDataStorageAccountName')]", 
            "properties": {
                "supportsHttpsTrafficOnly": true
            }, 
            "sku": {
                "name": "[variables('dataStorageAccountType')]", 
                "tier": "Standard"
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Storage/storageAccounts"
        }, 
        {
            "apiVersion": "[variables('computeApiVersion')]", 
            "condition": "[and(variables('useCustomImage'), variables('createNewCustomImage'))]", 
            "location": "[variables('location')]", 
            "name": "[variables('newCustomImageName')]", 
            "properties": {
                "storageProfile": {
                    "osDisk": {
                        "blobUri": "[variables('customImage')]", 
                        "osState": "Generalized", 
                        "osType": "Linux", 
                        "storageAccountType": "[if(contains(variables('premiumInstanceArray'), parameters('instanceType')), 'Premium_LRS', 'Standard_LRS')]"
                    }
                }
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Compute/images"
        }, 
        {
            "apiVersion": "[variables('computeApiVersion')]", 
            "dependsOn": [
                "[concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName'))]", 
                "[concat('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]", 
                "[variables('newCustomImageName')]", 
                "[concat('Microsoft.Network/networkInterfaces/', variables('mgmtNicName'))]", 
                "[concat('Microsoft.Network/networkInterfaces/', variables('intNicName'))]"
            ], 
            "location": "[variables('location')]", 
            "name": "[variables('instanceName')]", 
            "plan": "[if(variables('useCustomImage'), json('null'), variables('imagePlan'))]", 
            "properties": {
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets',variables('availabilitySetName'))]"
                }, 
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": true, 
                        "storageUri": "[reference(concat('Microsoft.Storage/storageAccounts/', variables('newDataStorageAccountName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).primaryEndpoints.blob]"
                    }
                }, 
                "hardwareProfile": {
                    "vmSize": "[parameters('instanceType')]"
                }, 
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('mgmtNicName'))]", 
                            "properties": {
                                "primary": true
                            }
                        }, 
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('intNicName'))]", 
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }, 
                "osProfile": {
                    "adminPassword": "[variables('adminPasswordOrKey')]", 
                    "adminUsername": "[parameters('adminUsername')]", 
                    "computerName": "[variables('instanceName')]", 
                    "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), json('null'), variables('linuxConfiguration'))]"
                }, 
                "storageProfile": "[if(variables('useCustomImage'), variables('storageProfileArray').customImage, variables('storageProfileArray').platformImage)]"
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Compute/virtualMachines"
        }, 
        {
            "apiVersion": "[variables('computeApiVersion')]", 
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('instanceName'))]"
            ], 
            "location": "[variables('location')]", 
            "name": "[concat(variables('instanceName'),'/start')]", 
            "properties": {
                "protectedSettings": {
                    "commandToExecute": "[concat('mkdir -p /var/log/cloud/azure; mkdir -p /config/cloud; echo ', variables('initScript'), ' | /usr/bin/base64 -d > /config/cloud/init.sh; chmod +x /config/cloud/init.sh;', ' /config/cloud/init.sh --cloud azure --log-level debug --data-interface eth1 --license ', parameters('bigIqLicenseKey1'), ' --ntp ', parameters('ntpServer'), ' --timezone ', parameters('timeZone'), ' --create-license-pool ', parameters('licensePoolKeys'), ' --create-reg-key-pool ', parameters('regPoolKeys'), ' --fcl-tag ', variables('f5CloudLibsTag'), ' --fcl-cloud-tag ', variables('f5CloudLibsAzureTag'), ' --vlan ', variables('singleQuote'), 'n:internal,nic:1.1', variables('singleQuote'), ' --self-ip ', variables('singleQuote'), 'n:internal_self,a:', variables('intSubnetPrivateAddress'), ',v:internal,i:eth1', variables('singleQuote'), ' --usage-analytics ', variables('singleQuote'), 'send:', parameters('allowUsageAnalytics'), ',r:', variables('location'), ',cI:', variables('subscriptionID'), ',dI:', variables('deploymentId'), ',cN:aws,lT:byol,bIV:6.0.0,tN:f5-existing-stack-byol-2nic-bigiq,tV:4.3.0', variables('singleQuote'), ' &>> /var/log/cloud/azure/install.log &')]"
                }, 
                "publisher": "Microsoft.Azure.Extensions", 
                "type": "CustomScript", 
                "typeHandlerVersion": "2.0"
            }, 
            "tags": "[if(empty(variables('tagValues')), json('null'), variables('tagValues'))]", 
            "type": "Microsoft.Compute/virtualMachines/extensions"
        }
    ], 
    "outputs": {
        "GUI-URL": {
            "type": "string", 
            "value": "[concat('https://', reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ':', 443)]"
        }, 
        "SSH-URL": {
            "type": "string", 
            "value": "[concat(reference(variables('mgmtPublicIPAddressId')).dnsSettings.fqdn, ' ',22)]"
        }
    }
}